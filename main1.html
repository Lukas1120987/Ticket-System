<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>üé¢ FunPark ‚Äì Statisches Ticketsystem (Abiturprojekt)</title>

<!-- ================= FONTS & LIBRARIES ================= -->
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://unpkg.com/html5-qrcode"></script>

<!-- ================= STYLES ================= -->
<style>

/* ======================================================
   THEME VARIABLES (Light / Dark Mode)
   ====================================================== */
:root{
  --bg:#f4f6fa;
  --card:#ffffff;
  --primary:#1976d2;
  --accent:#ff9800;
  --text:#1f1f1f;
  --muted:#666;
  --success:#4caf50;
  --error:#f44336;
}

body.dark{
  --bg:#0f1115;
  --card:#1c1f26;
  --primary:#90caf9;
  --accent:#ffb74d;
  --text:#eaeaea;
  --muted:#aaa;
}

/* ======================================================
   GLOBAL BASE
   ====================================================== */
*{
  box-sizing:border-box;
  margin:0;
  padding:0;
  font-family:"Montserrat",sans-serif;
}

body{
  background:var(--bg);
  color:var(--text);
  min-height:100vh;
  transition:background .3s,color .3s;
}

button{cursor:pointer}

/* ======================================================
   HEADER & NAVIGATION
   ====================================================== */
header{
  background:linear-gradient(135deg,var(--primary),#0d47a1);
  color:#fff;
  padding:1.4rem;
  text-align:center;
  box-shadow:0 4px 20px rgba(0,0,0,.3);
}

nav{
  margin-top:1rem;
  display:flex;
  justify-content:center;
  gap:.6rem;
  flex-wrap:wrap;
}

nav button{
  border:none;
  padding:.6rem 1.1rem;
  border-radius:999px;
  font-weight:600;
}

/* ======================================================
   MAIN LAYOUT
   ====================================================== */
main{
  max-width:1200px;
  margin:2rem auto;
  padding:2rem;
  background:var(--card);
  border-radius:22px;
  box-shadow:0 10px 40px rgba(0,0,0,.25);
  animation:fade .4s ease;
}

section{display:none}
section.active{display:block}

/* ======================================================
   COMPONENTS
   ====================================================== */
h2{
  color:var(--primary);
  margin-bottom:1rem;
}

.card{
  background:var(--bg);
  padding:1.5rem;
  border-radius:16px;
  box-shadow:0 4px 15px rgba(0,0,0,.15);
  margin-top:1rem;
}

.grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(260px,1fr));
  gap:1.5rem;
}

/* ======================================================
   FORMS
   ====================================================== */
form{
  display:flex;
  flex-direction:column;
  gap:1rem;
}

input,select,textarea{
  padding:.8rem;
  border-radius:10px;
  border:1px solid #ccc;
  font-size:1rem;
}

button.primary{
  background:var(--primary);
  color:#fff;
  border:none;
  padding:.9rem;
  border-radius:12px;
  font-weight:700;
}

button.secondary{
  background:transparent;
  border:2px solid var(--primary);
  color:var(--primary);
  padding:.7rem;
  border-radius:12px;
}

/* ======================================================
   TICKET CARD
   ====================================================== */
.ticket{
  position:relative;
}

.badge{
  position:absolute;
  top:1rem;
  right:1rem;
  padding:.35rem .7rem;
  border-radius:999px;
  font-size:.75rem;
  font-weight:700;
}

.valid{background:var(--success);color:#fff}
.used{background:var(--error);color:#fff}

/* ======================================================
   SCANNER GATE
   ====================================================== */
#gate{
  height:200px;
  border-radius:16px;
  border:5px solid #ccc;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:2rem;
  font-weight:700;
  margin-bottom:1rem;
  transition:.4s;
}

.gate-ok{border-color:var(--success);color:var(--success)}
.gate-bad{border-color:var(--error);color:var(--error)}

/* ======================================================
   FLOATING BUTTON
   ====================================================== */
.fab{
  position:fixed;
  right:20px;
  bottom:20px;
  width:55px;
  height:55px;
  border-radius:50%;
  border:none;
  background:var(--accent);
  font-size:1.4rem;
}

/* ======================================================
   ANIMATION
   ====================================================== */
@keyframes fade{
  from{opacity:0;transform:translateY(10px)}
  to{opacity:1;transform:none}
}

</style>
</head>

<body>

<!-- ================= HEADER ================= -->
<header>
  <h1>üé¢ FunPark</h1>
  <p>Statisches Ticketsystem ‚Äì Informatik Abiturprojekt</p>
  <nav>
    <button onclick="go('home')">Start</button>
    <button onclick="go('buy')">Tickets kaufen</button>
    <button onclick="go('my')">Meine Tickets</button>
    <button onclick="go('scan')">Scanner-Login</button>
  </nav>
</header>

<!-- ================= MAIN ================= -->
<main>

<section id="home" class="active">
  <h2>Willkommen</h2>
  <div class="grid">
    <div class="card">üéüÔ∏è Ticketverwaltung</div>
    <div class="card">üí≥ Realistische Zahlung (Demo)</div>
    <div class="card">üì± QR-Scanner & Entwertung</div>
  </div>
</section>

<section id="buy">
  <h2>üéüÔ∏è Ticket kaufen</h2>
  <form id="buyForm">
    <select id="user">
      <option>Max</option>
      <option>Anna</option>
      <option>Tom</option>
      <option>Lea</option>
    </select>

    <select id="ticketType">
      <option value="Tagesticket|35">Tagesticket ‚Äì 35 ‚Ç¨</option>
      <option value="2-Tage-Ticket|60">2 Tage ‚Äì 60 ‚Ç¨</option>
      <option value="VIP-Ticket|150">VIP ‚Äì 150 ‚Ç¨</option>
    </select>

    <button class="primary">Zur Zahlung üîê</button>
  </form>
</section>

<section id="my">
  <h2>üí≥ Meine Tickets</h2>
  <select id="viewUser">
    <option>Max</option>
    <option>Anna</option>
    <option>Tom</option>
    <option>Lea</option>
  </select>
  <button class="secondary" onclick="loadTickets()">Anzeigen</button>
  <div id="ticketList"></div>
</section>

<section id="scan">
  <h2>üîê Scanner-Login (Einlass)</h2>

  <div id="gate">üü° Bereit</div>

  <div class="card">
    <input id="manualCode" placeholder="Ticketcode manuell eingeben">
    <button class="primary" onclick="validateTicket()">Pr√ºfen</button>
  </div>

  <div class="card">
    <div id="reader"></div>
  </div>
</section>

</main>

<button class="fab" onclick="toggleDark()">üåô</button>

<!-- ================= SCRIPT ================= -->
<script>

/* ======================================================
   STATE MANAGEMENT
   ====================================================== */
let tickets = JSON.parse(localStorage.getItem("tickets")) || [];

/* ======================================================
   NAVIGATION
   ====================================================== */
function go(id){
  document.querySelectorAll("section").forEach(s=>s.classList.remove("active"));
  document.getElementById(id).classList.add("active");
}

/* ======================================================
   DARK MODE
   ====================================================== */
function toggleDark(){
  document.body.classList.toggle("dark");
  localStorage.setItem("dark",document.body.classList.contains("dark"));
}
if(localStorage.getItem("dark")==="true"){
  document.body.classList.add("dark");
}

/* ======================================================
   BUY & PAYMENT
   ====================================================== */
document.getElementById("buyForm").addEventListener("submit",e=>{
  e.preventDefault();

  const [type,price] = ticketType.value.split("|");
  const paymentData = {
    user:user.value,
    type,
    price
  };

  localStorage.setItem("pendingPayment",JSON.stringify(paymentData));
  openPaymentPage();
});

/* ---- Payment Page (New Tab) ---- */
function openPaymentPage(){
  const w = window.open("","_blank");
  w.document.write(`
<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>PayFun Secure ‚Äì Zahlung</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">

<style>
/* =====================================================
   GLOBAL
   ===================================================== */
*{box-sizing:border-box;font-family:Montserrat;margin:0}
body{
  background:#f3f5f9;
  min-height:100vh;
  display:flex;
  align-items:center;
  justify-content:center;
}

/* =====================================================
   PAYMENT CONTAINER
   ===================================================== */
.payment{
  width:100%;
  max-width:430px;
  background:#fff;
  border-radius:18px;
  box-shadow:0 20px 60px rgba(0,0,0,.25);
  overflow:hidden;
}

/* =====================================================
   HEADER
   ===================================================== */
.header{
  background:linear-gradient(135deg,#1a73e8,#0d47a1);
  color:#fff;
  padding:1.5rem;
}
.header h1{
  font-size:1.3rem;
}
.header p{
  font-size:.9rem;
  opacity:.9;
}

/* =====================================================
   CONTENT
   ===================================================== */
.content{
  padding:1.5rem;
}

.amount{
  font-size:1.5rem;
  font-weight:700;
  margin-bottom:.5rem;
}
.muted{color:#666;font-size:.9rem}

/* =====================================================
   CARD PREVIEW
   ===================================================== */
.card-preview{
  background:linear-gradient(135deg,#222,#444);
  color:#fff;
  border-radius:16px;
  padding:1.2rem;
  margin:1.2rem 0;
}
.card-number{
  font-size:1.2rem;
  letter-spacing:2px;
}
.card-row{
  display:flex;
  justify-content:space-between;
  margin-top:1rem;
  font-size:.85rem;
}

/* =====================================================
   FORM
   ===================================================== */
form{
  display:flex;
  flex-direction:column;
  gap:.8rem;
}

input{
  padding:.75rem;
  border-radius:10px;
  border:1px solid #ccc;
  font-size:1rem;
}

.row{
  display:flex;
  gap:.6rem;
}

/* =====================================================
   BUTTONS
   ===================================================== */
button{
  padding:.85rem;
  border:none;
  border-radius:12px;
  font-weight:700;
  font-size:1rem;
}

.pay{
  background:#1a73e8;
  color:#fff;
  margin-top:.5rem;
}

.cancel{
  background:transparent;
  color:#666;
}

/* =====================================================
   SECURITY
   ===================================================== */
.security{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-top:1rem;
  font-size:.75rem;
  color:#666;
}

/* =====================================================
   LOADING / 3DS
   ===================================================== */
.overlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.6);
  display:none;
  align-items:center;
  justify-content:center;
}

.modal{
  background:#fff;
  padding:2rem;
  border-radius:16px;
  width:90%;
  max-width:360px;
  text-align:center;
}
progress{width:100%;margin-top:1rem}
</style>
</head>

<body>

<div class="payment">

  <!-- HEADER -->
  <div class="header">
    <h1>üîí PayFun Secure</h1>
    <p>Sichere Online-Zahlung</p>
  </div>

  <!-- CONTENT -->
  <div class="content">
    <div class="amount" id="amount">‚Äì ‚Ç¨</div>
    <div class="muted" id="info">‚Äì</div>

    <!-- CARD PREVIEW -->
    <div class="card-preview">
      <div class="card-number" id="previewNumber">‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢</div>
      <div class="card-row">
        <span id="previewName">KARTENINHABER</span>
        <span id="previewDate">MM/YY</span>
      </div>
    </div>

    <!-- FORM -->
    <form onsubmit="startPayment(event)">
      <input placeholder="Karteninhaber" id="name" required>
      <input placeholder="Kartennummer" id="number" maxlength="19" required>
      <div class="row">
        <input placeholder="MM/YY" id="date" required>
        <input placeholder="CVC" id="cvc" maxlength="3" required>
      </div>

      <button class="pay">Jetzt bezahlen</button>
      <button type="button" class="cancel" onclick="window.close()">Abbrechen</button>
    </form>

    <!-- SECURITY -->
    <div class="security">
      <span>üîê SSL verschl√ºsselt</span>
      <span>PCI-DSS ‚úî</span>
    </div>
  </div>
</div>

<!-- OVERLAY -->
<div class="overlay" id="overlay">
  <div class="modal">
    <h3>3-D Secure</h3>
    <p>Ihre Zahlung wird √ºberpr√ºft‚Ä¶</p>
    <progress id="prog" max="100" value="0"></progress>
  </div>
</div>

<script>
/* =====================================================
   LOAD PAYMENT DATA
   ===================================================== */
const d = JSON.parse(localStorage.getItem("pendingPayment"));
document.getElementById("amount").textContent = d.price + " ‚Ç¨";
document.getElementById("info").textContent = d.type;

/* =====================================================
   LIVE CARD PREVIEW
   ===================================================== */
number.oninput = e=>{
  let v = e.target.value.replace(/\D/g,"").substring(0,16);
  v = v.replace(/(.{4})/g,"$1 ").trim();
  e.target.value = v;
  previewNumber.textContent = v || "‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢";
};
name.oninput = e=>previewName.textContent = e.target.value.toUpperCase() || "KARTENINHABER";
date.oninput = e=>previewDate.textContent = e.target.value || "MM/YY";

/* =====================================================
   PAYMENT FLOW
   ===================================================== */
function startPayment(e){
  e.preventDefault();
  overlay.style.display="flex";

  let v=0;
  const i=setInterval(()=>{
    prog.value = v+=20;
    if(v>=100){
      clearInterval(i);
      finishPayment();
    }
  },300);
}

function finishPayment(){
  const code = "TCK-"+crypto.getRandomValues(new Uint32Array(1))[0].toString(16);
  const t = JSON.parse(localStorage.getItem("tickets")) || [];
  t.push({...d,code,redeemed:false});
  localStorage.setItem("tickets",JSON.stringify(t));
  alert("‚úÖ Zahlung erfolgreich");
  window.close();
}
</script>

</body>
</html>
`);
}

/* ======================================================
   TICKET DISPLAY
   ====================================================== */
function loadTickets(){
  tickets = JSON.parse(localStorage.getItem("tickets")) || [];
  ticketList.innerHTML = "";

  tickets.filter(t=>t.user===viewUser.value).forEach(t=>{
    const div = document.createElement("div");
    div.className = "card ticket";
    div.innerHTML = `
      <span class="badge ${t.redeemed?"used":"valid"}">
        ${t.redeemed?"ENTWERTET":"G√úLTIG"}
      </span>
      <strong>${t.code}</strong><br>
      ${t.type} ‚Äì ${t.price} ‚Ç¨
      <div id="qr${t.code}"></div>
      <button onclick="downloadPDF('${t.code}','${t.type}','${t.price}')">PDF</button>
    `;
    ticketList.appendChild(div);
    new QRCode(document.getElementById("qr"+t.code),t.code);
  });
}

/* ======================================================
   PDF EXPORT
   ====================================================== */
function downloadPDF(code,type,price){
  const {jsPDF} = window.jspdf;
  const pdf = new jsPDF();
  pdf.text("FunPark Ticket",20,20);
  pdf.text("Ticketcode: "+code,20,30);
  pdf.text(type+" ‚Äì "+price+" ‚Ç¨",20,40);
  pdf.save(code+".pdf");
}

/* ======================================================
   SCANNER & VALIDATION
   ====================================================== */
function validateTicket(scanned){
  const code = scanned || manualCode.value.trim();
  const gate = document.getElementById("gate");

  const t = tickets.find(x=>x.code===code);
  if(!t){
    gate.className="gate-bad";
    gate.textContent="‚ùå Ung√ºltig";
    return;
  }
  if(t.redeemed){
    gate.className="gate-bad";
    gate.textContent="‚ö†Ô∏è Bereits genutzt";
    return;
  }

  t.redeemed=true;
  localStorage.setItem("tickets",JSON.stringify(tickets));
  gate.className="gate-ok";
  gate.textContent="‚úÖ Zutritt erlaubt";
}

/* ---- Camera QR Scanner ---- */
new Html5Qrcode("reader").start(
  {facingMode:"environment"},
  {fps:10,qrbox:250},
  txt=>validateTicket(txt)
);

</script>

</body>
</html>
