<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ¢ FunPark â€“ VollstÃ¤ndiges Ticketsystem</title>

<!-- ================= EXTERNE LIBRARIES ================= -->
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://unpkg.com/html5-qrcode"></script>

<!-- ================= STYLE ================= -->
<style>
/* =======================================================
   GLOBAL THEME
======================================================= */
:root{
  --bg:#f4f6fa;
  --card:#ffffff;
  --primary:#1976d2;
  --accent:#ff9800;
  --text:#1f1f1f;
  --muted:#666;
  --success:#4caf50;
  --error:#f44336;
  --shadow:0 10px 35px rgba(0,0,0,.18);
}

body.dark{
  --bg:#0f1115;
  --card:#1c1f26;
  --primary:#90caf9;
  --accent:#ffb74d;
  --text:#eaeaea;
  --muted:#aaa;
}

/* =======================================================
   BASE
======================================================= */
*{
  box-sizing:border-box;
  font-family:Montserrat,system-ui,sans-serif;
  margin:0;
  padding:0;
}

body{
  background:var(--bg);
  color:var(--text);
  min-height:100vh;
}

button{cursor:pointer}
h1,h2,h3{font-weight:700}

/* =======================================================
   HEADER / NAV
======================================================= */
header{
  background:linear-gradient(135deg,var(--primary),#0d47a1);
  color:#fff;
  padding:1.6rem;
  text-align:center;
  box-shadow:var(--shadow);
}

nav{
  margin-top:1.2rem;
  display:flex;
  justify-content:center;
  gap:.6rem;
  flex-wrap:wrap;
}

nav button{
  border:none;
  padding:.6rem 1.1rem;
  border-radius:999px;
  font-weight:600;
}

/* =======================================================
   MAIN LAYOUT
======================================================= */
main{
  max-width:1200px;
  margin:2.5rem auto;
  padding:2rem;
  background:var(--card);
  border-radius:22px;
  box-shadow:var(--shadow);
}

section{display:none}
section.active{display:block}

/* =======================================================
   COMPONENTS
======================================================= */
.grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(260px,1fr));
  gap:1.5rem;
}

.card{
  background:var(--bg);
  padding:1.6rem;
  border-radius:18px;
  box-shadow:0 4px 15px rgba(0,0,0,.15);
}

h2{color:var(--primary);margin-bottom:1rem}

/* =======================================================
   FORMS
======================================================= */
form{display:flex;flex-direction:column;gap:1rem}
input,select{
  padding:.8rem;
  border-radius:10px;
  border:1px solid #ccc;
  font-size:1rem;
}

button.primary{
  background:var(--primary);
  color:#fff;
  border:none;
  padding:.9rem;
  border-radius:12px;
  font-weight:700;
}

button.secondary{
  background:transparent;
  border:2px solid var(--primary);
  color:var(--primary);
  padding:.7rem;
  border-radius:12px;
}

/* =======================================================
   TICKETS
======================================================= */
.ticket{
  position:relative;
}

.badge{
  position:absolute;
  top:1rem;
  right:1rem;
  padding:.35rem .8rem;
  border-radius:999px;
  font-size:.75rem;
  font-weight:700;
}

.valid{background:var(--success);color:#fff}
.used{background:var(--error);color:#fff}

/* =======================================================
   SCANNER
======================================================= */
#gate{
  height:190px;
  border-radius:18px;
  border:5px solid #ccc;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:2rem;
  font-weight:700;
  margin-bottom:1rem;
}

.gate-ok{border-color:var(--success);color:var(--success)}
.gate-bad{border-color:var(--error);color:var(--error)}

/* =======================================================
   FLOATING BUTTON
======================================================= */
.fab{
  position:fixed;
  right:20px;
  bottom:20px;
  width:55px;
  height:55px;
  border-radius:50%;
  border:none;
  background:var(--accent);
  font-size:1.4rem;
  box-shadow:var(--shadow);
}
</style>
</head>

<body>

<!-- =======================================================
     HEADER
======================================================= -->
<header>
  <h1>ğŸ¢ FunPark</h1>
  <p>VollstÃ¤ndiges Ticketsystem â€“ Informatik Abiturprojekt</p>
  <nav>
    <button onclick="go('home')">Start</button>
    <button onclick="go('shop')">Ticketshop</button>
    <button onclick="go('my')">Meine Tickets</button>
    <button onclick="go('scan')">Einlass</button>
    <button onclick="go('admin')">Admin</button>
  </nav>
</header>

<!-- =======================================================
     MAIN
======================================================= -->
<main>

<!-- ================= HOME ================= -->
<section id="home" class="active">
  <h2>Willkommen im FunPark</h2>
  <div class="grid">
    <div class="card">ğŸŸï¸ Online Ticketshop</div>
    <div class="card">ğŸ’³ Zahlungssimulation</div>
    <div class="card">ğŸ“± QR-Code Tickets</div>
    <div class="card">ğŸ” Digitaler Einlass</div>
    <div class="card">ğŸ“„ PDF-Download</div>
    <div class="card">ğŸ“Š Admin-Statistiken</div>
  </div>
</section>

<!-- ================= SHOP ================= -->
<section id="shop">
  <h2>ğŸŸï¸ Ticket kaufen</h2>
  <form id="buyForm">
    <select id="user">
      <option>Max</option><option>Anna</option><option>Tom</option><option>Lea</option>
    </select>

    <select id="ticketType">
      <option value="Tagesticket|35|1">Tagesticket â€“ 35 â‚¬</option>
      <option value="Wochenende|60|2">Wochenende â€“ 60 â‚¬</option>
      <option value="VIP|150|30">VIP â€“ 150 â‚¬</option>
    </select>

    <button class="primary">Zur Zahlung</button>
  </form>
</section>

<!-- ================= MY TICKETS ================= -->
<section id="my">
  <h2>ğŸ’³ Meine Tickets</h2>
  <select id="viewUser">
    <option>Max</option><option>Anna</option><option>Tom</option><option>Lea</option>
  </select>
  <button class="secondary" onclick="loadTickets()">Anzeigen</button>
  <div id="ticketList"></div>
</section>

<!-- ================= SCANNER ================= -->
<section id="scan">
  <h2>ğŸ” Einlasskontrolle</h2>
  <div id="gate">ğŸŸ¡ Bereit</div>
  <div class="card">
    <input id="manualCode" placeholder="Ticketcode eingeben">
    <button class="primary" onclick="validateTicket()">PrÃ¼fen</button>
  </div>
  <div class="card">
    <div id="reader"></div>
  </div>
</section>

<!-- ================= ADMIN ================= -->
<section id="admin">
  <h2>ğŸ› ï¸ Admin-Dashboard</h2>
  <div class="grid">
    <div class="card">
      <h3>ğŸŸï¸ Tickets verkauft</h3>
      <p id="statTickets">0</p>
    </div>
    <div class="card">
      <h3>ğŸ’° Umsatz</h3>
      <p id="statRevenue">0 â‚¬</p>
    </div>
    <div class="card">
      <h3>ğŸšª EinlÃ¤sse heute</h3>
      <p id="statEntries">0</p>
    </div>
  </div>
</section>

</main>

<button class="fab" onclick="toggleDark()">ğŸŒ™</button>

<!-- =======================================================
     SCRIPT
======================================================= -->
<script>
/* =======================================================
   STATE MANAGEMENT
======================================================= */
function getTickets(){
  return JSON.parse(localStorage.getItem("tickets")) || [];
}
function saveTickets(t){
  localStorage.setItem("tickets",JSON.stringify(t));
}

/* =======================================================
   NAVIGATION
======================================================= */
function go(id){
  document.querySelectorAll("section").forEach(s=>s.classList.remove("active"));
  document.getElementById(id).classList.add("active");
  if(id==="scan") startScanner();
  if(id==="admin") loadStats();
}

/* =======================================================
   DARK MODE
======================================================= */
function toggleDark(){
  document.body.classList.toggle("dark");
  localStorage.setItem("dark",document.body.classList.contains("dark"));
}
if(localStorage.getItem("dark")==="true") document.body.classList.add("dark");

/* =======================================================
   BUY FLOW
======================================================= */

/* =======================================================
   PAYMENT SYSTEM â€“ KOMPLETT
======================================================= */

let pendingPayment = null;

/* ================= START PAYMENT ================= */
buyForm.onsubmit = e => {
  e.preventDefault();

  const [type, price, days] = ticketType.value.split("|");

  pendingPayment = {
    user: user.value,
    type,
    price: Number(price),
    days: Number(days),
    status: "offen",
    createdAt: new Date().toISOString()
  };

  showPaymentPage();
};

/* ================= PAYMENT PAGE ================= */
function showPaymentPage() {
  const old = document.getElementById("paymentPage");
  if (old) old.remove();

  const section = document.createElement("section");
  section.id = "paymentPage";
  section.className = "active";

  section.innerHTML = `
    <h2>ğŸ’³ Zahlung abschlieÃŸen</h2>
    <div class="card">
      <p><b>Kunde:</b> ${pendingPayment.user}</p>
      <p><b>Ticket:</b> ${pendingPayment.type}</p>
      <p><b>Preis:</b> ${pendingPayment.price} â‚¬</p>

      <hr><br>

      <label>Zahlungsmethode</label>
      <select id="paymentMethod">
        <option>Kreditkarte</option>
        <option>PayPal</option>
        <option>Apple / Google Pay</option>
      </select>

      <br><br>
      <button class="primary" onclick="pay()">Jetzt bezahlen</button>
      <button class="secondary" onclick="cancelPayment()">Abbrechen</button>
    </div>
  `;

  document.querySelector("main").appendChild(section);

  document.querySelectorAll("main section")
    .forEach(s => s.id !== "paymentPage" && s.classList.remove("active"));
}

/* ================= PAY ================= */
function pay() {
  if (!pendingPayment) return;

  const code = "FP-" + Math.random().toString(36).substr(2, 8).toUpperCase();
  const now = new Date();
  const validUntil = new Date(
    now.getTime() + pendingPayment.days * 86400000
  );

  const ticket = {
    user: pendingPayment.user,
    type: pendingPayment.type,
    price: pendingPayment.price,
    code,
    validUntil: validUntil.toISOString(),
    lastUsed: null,
    paidAt: now.toISOString(),
    paymentMethod: paymentMethod.value,
    status: "bezahlt"
  };

  const tickets = getTickets();
  tickets.push(ticket);
  saveTickets(tickets);

  downloadInvoice(ticket);

  pendingPayment = null;

  alert("âœ… Zahlung erfolgreich!\nTicket-Code: " + code);
  go("my");
}

/* ================= CANCEL PAYMENT ================= */
function cancelPayment() {
  if (pendingPayment) {
    pendingPayment.status = "storniert";
    pendingPayment = null;
  }

  const page = document.getElementById("paymentPage");
  if (page) page.remove();

  alert("âŒ Zahlung abgebrochen");
  go("shop");
}

/* ================= INVOICE PDF ================= */
function downloadInvoice(ticket) {
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF();

  pdf.setFontSize(18);
  pdf.text("FunPark â€“ Rechnung", 20, 20);

  pdf.setFontSize(12);
  pdf.text("Kunde: " + ticket.user, 20, 40);
  pdf.text("Ticket: " + ticket.type, 20, 50);
  pdf.text("Ticket-Code: " + ticket.code, 20, 60);
  pdf.text("Preis: " + ticket.price + " â‚¬", 20, 70);
  pdf.text("Zahlungsmethode: " + ticket.paymentMethod, 20, 80);
  pdf.text("Zahlungsdatum: " + new Date(ticket.paidAt).toLocaleString(), 20, 90);

  pdf.text("Status: BEZAHLT", 20, 110);

  pdf.save("Rechnung-" + ticket.code + ".pdf");
}

/* =======================================================
   LOAD TICKETS
======================================================= */
function loadTickets(){
  const t=getTickets();
  ticketList.innerHTML="";
  t.filter(x=>x.user===viewUser.value).forEach(x=>{
    const expired=new Date(x.validUntil)<new Date();
    const d=document.createElement("div");
    d.className="card ticket";
    d.innerHTML=`
      <span class="badge ${expired?"used":"valid"}">
        ${expired?"ABGELAUFEN":"GÃœLTIG"}
      </span>
      <b>${x.code}</b><br>
      ${x.type} â€“ ${x.price} â‚¬<br>
      GÃ¼ltig bis: ${new Date(x.validUntil).toLocaleDateString()}
      <div id="qr${x.code}"></div>
      <button class="secondary" onclick="downloadPDF('${x.code}')">PDF</button>
    `;
    ticketList.appendChild(d);
    new QRCode(document.getElementById("qr"+x.code),x.code);
  });
}

/* =======================================================
   PDF EXPORT
======================================================= */
function downloadPDF(code){
  const t=getTickets().find(x=>x.code===code);
  const {jsPDF}=window.jspdf;
  const pdf=new jsPDF();
  pdf.text("FunPark Ticket",20,20);
  pdf.text("Code: "+t.code,20,35);
  pdf.text("Typ: "+t.type,20,45);
  pdf.text("GÃ¼ltig bis: "+new Date(t.validUntil).toLocaleDateString(),20,55);
  pdf.save("Ticket-"+t.code+".pdf");
}

/* =======================================================
   SCANNER
======================================================= */
let scanner=null;
function startScanner(){
  if(scanner) return;
  scanner=new Html5Qrcode("reader");
  scanner.start({facingMode:"environment"},{fps:10,qrbox:250},
    code=>validateTicket(code)
  );
}

function validateTicket(code){
  const gate=document.getElementById("gate");
  const t=getTickets();
  const ticket=t.find(x=>x.code===(code||manualCode.value.trim()));
  if(!ticket){
    gate.className="gate-bad";
    gate.textContent="âŒ UngÃ¼ltig";
    return;
  }
  if(new Date(ticket.validUntil)<new Date()){
    gate.className="gate-bad";
    gate.textContent="â›” Abgelaufen";
    return;
  }
  const today=new Date().toDateString();
  if(ticket.lastUsed===today){
    gate.className="gate-bad";
    gate.textContent="âš ï¸ Heute bereits genutzt";
    return;
  }
  ticket.lastUsed=today;
  saveTickets(t);
  gate.className="gate-ok";
  gate.textContent="âœ… Zutritt erlaubt";
}

/* =======================================================
   ADMIN STATS
======================================================= */
function loadStats(){
  const t=getTickets();
  document.getElementById("statTickets").textContent=t.length;
  document.getElementById("statRevenue").textContent=
    t.reduce((s,x)=>s+x.price,0)+" â‚¬";
  document.getElementById("statEntries").textContent=
    t.filter(x=>x.lastUsed===new Date().toDateString()).length;
}
</script>

</body>
</html>
